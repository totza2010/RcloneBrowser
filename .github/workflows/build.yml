name: Build Rclone Browser

on:
  push:
    tags:
      - 'v*'
  
jobs:
  build_windows:
    name: Windows Build
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
      - name: Install Development Tools
        run: |
          choco install visualstudio2022community visualstudio2022-workload-nativedesktop cmake 7zip innosetup -y
          choco install openssl --version=1.1.1.2100 -y
          Remove-Item -Recurse -Force C:\Qt -ErrorAction SilentlyContinue
          mkdir C:\Qt
          pushd C:\Qt
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.9.3'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2022_64'
          dir: 'C:'
          modules: 'qtmultimedia'
      - name: Build & Package (via CMD script)
        shell: cmd
        run: scripts\release_windows.cmd
      - uses: actions/upload-artifact@v4
        with:
          name: windows-portable
          path: release/rclone-browser-*-windows-64-bit
      - uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: release/rclone-browser-*-windows-64-bit.exe
          
  build_linux:
    name: Linux Build
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      - name: Install Development Tools
        run: |
          sudo apt update
          sudo apt -y install git g++ cmake make qt6-base-dev qt6-multimedia-dev
      - name: Build Rclone Browser
        run: |
          VERSION=$(cat VERSION)
          COMMIT=$(git rev-parse --short HEAD)
          VERSION_COMMIT="$VERSION-$COMMIT"

          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          make -j$(nproc)

          # สร้าง release directory เหมือนกับ Windows build
          cd ..
          mkdir -p release/rclone-browser-${VERSION_COMMIT}-linux
          cp README.md CHANGELOG.md LICENSE build/build/rclone-browser release/rclone-browser-${VERSION_COMMIT}-linux/
          
      - uses: actions/upload-artifact@v4
        with:
         name: linux
         path: release/rclone-browser-*-linux/

  create_release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build_windows, build_linux]
    
    steps:
      - uses: actions/checkout@v4
      - name: Create artifact directory
        run: rm -rf /tmp/artifacts && mkdir /tmp/artifacts
      - uses: actions/download-artifact@v4
        with:
          path: /tmp/artifacts
      - name: Compress artifacts
        run: |
          pushd /tmp/artifacts
          for i in *;do zip -r -0 $i.zip $i;done
          popd
          
      - name: Get short commit
        run: echo "SHORT_SHA=`echo ${GITHUB_SHA} | cut -c1-8`" >> $GITHUB_ENV
        
      - uses: rickstaa/action-create-tag@v1
        with:
          tag: release-${{ env.SHORT_SHA }}
          tag_exists_error: false
          
      - uses: ncipollo/release-action@v1
        with:
          artifacts: "/tmp/artifacts/*.zip"
          name: Rclone Browser Autobuild For Commit ${{ env.SHORT_SHA }}
          omitBody: true
          generateReleaseNotes: true
          prerelease: false
          skipIfReleaseExists: true
          tag: release-${{ env.SHORT_SHA }}
        